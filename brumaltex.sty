%
% brumaltex - A compilation of LaTeX packages and macros used by the author.
%
% Author: Noah D. Ortiz <abstractednoah@brumal.org>
%

%
% NOTES:
%
%   The author uses the 'tectonic' LaTeX engine, which aims to replicate the
%   behavior of XeLaTeX and require only the TeXLive distribution. Any packages
%   that brumaltex requires but that tectonic doesn't support (none at the
%   moment) will be shipped with this package.
%
%   The 'develop' branch of this repository may be experimental, but 'master'
%   has been tested with 'tectonic' (please post to Issues if you find a bug!).
%
%   For simplicity, the brumaltex package is shipped as a standalone file (in
%   the sense that its only current dependencies are provided by 'tectonic', see
%   above). This makes sharing documents that use the package easy (just include
%   this file alongside your tex file). But it makes it difficult to only use a
%   single feature of the package without using all the features. For instance,
%   your headers will be formatted automatically if you use brumaltex. It is a
%   TODO to make this package modularly configurable on import.
%
%   We have attempted to prefix most names introduced by this package by 'bt'
%   and follow camelCase. However, the first iteration of the package didn't
%   follow this convention, and we're still working on migrating over, having to
%   wrestle with legacy support as well. This convention does not apply to
%   "shorthand" commands.
%
% (TODO: Move notes to README.)
%


\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{brumaltex}[2021/03/31]

%
% Utilities (that don't need any imports)
%
% Short makeat commands.
\newcommand{\AL}{\makeatletter}
\newcommand{\AO}{\makeatother}

% TODO
% swapMacros
%   Swap two macro names.
%\newcommand{\swapMacros}{ ... }


%
% Import packages
%
% Standard library.
\RequirePackage{amsmath, amssymb, amsthm}
\RequirePackage{mathtools}
\RequirePackage{physics}

% Fonts.
\RequirePackage{mathrsfs}
\RequirePackage{stmaryrd}

% Common list packages.
\RequirePackage{enumerate}
\RequirePackage{enumitem}
\RequirePackage[ampersand]{easylist} % Choose the "&" symbol to denote items.

% Tables.
\RequirePackage{booktabs}

% Units.
\RequirePackage[load=accepted,load=prefixed,load=abbr]{siunitx}

% Graphics.
\RequirePackage{graphicx}

% Restrain figures to sections.
\RequirePackage[section]{placeins}

% Chemistry.
\RequirePackage[version=4]{mhchem}

% Better equation boxing, etc.
\RequirePackage{empheq}

% Line spacing.
\RequirePackage{setspace}

% Headers.
\RequirePackage{fancyhdr}
\RequirePackage{lastpage}

% Custom date format.
\RequirePackage{datetime2}

% Prettier with microtype!
\RequirePackage{microtype}

% Colors.
\RequirePackage{xcolor}

% Links.
\RequirePackage{varioref}
\RequirePackage{hyperref}
\RequirePackage[nameinlink]{cleveref}

% Reasonable margins.
\RequirePackage{fullpage}

% Programming.
\RequirePackage{xifthen}

% Deprecated.
%\RequirePackage{needspace}
%\RequirePackage[small,compact]{titlesec}


%
% Configure datetime2
%
\DTMusemodule{english}{en-NZ}
\DTMsetstyle{en-NZ}


%
% Configure xcolor
%
\definecolor{blueish}{rgb}{0.0,0.1,0.4}
\definecolor{greenish}{rgb}{0.0,0.4,0.0}


%
% Configure references
%
\hypersetup{
    linktocpage,
    colorlinks=true,
    linkcolor=blueish,
    citecolor=greenish
}

%
% Utilities (after package imports)
%
% rehdr
%   Run this anywhere to reset header after possible disruption.
% TODO: find source (some stackoverflow).
\AL
\ifcsname f@nch@setoffs\endcsname\else
    \let\f@nch@setoffs\fancy@setoffs
\fi
\newcommand{\rehdr}{\f@nch@setoffs}
\AO

% btThisIfThat
%   Expand #1 if #2 is not empty.
\newcommand{\btThisIfThat}[2]{%%
    \ifthenelse{\equal{#2}{}}{}{#1}%%
}


%
% Environments
%
% Environment name parameters.
\AL
\newcommand{\@btProblemTitle}{Problem}
    \newcommand{\btProblemTitle}[1]{\renewcommand{\@btProblemTitle}{#1}}
\newcommand{\@btSolutionTitle}{Solution}
    \newcommand{\btSolutionTitle}[1]{\renewcommand{\@btSolutionTitle}{#1}}
\AO

% Custom theorem styles.
\newtheoremstyle{btProblem}
    {}
    {}
    {}
    {}
    {\bfseries}
    {.}
    {1em}
    {\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}}
\newtheoremstyle{btProblem*}
    {}
    {}
    {}
    {}
    {\bfseries}
    {.}
    {1em}
    {\thmname{#1}\thmnote{ #3}}

\theoremstyle{plain}
  \newtheorem{theorem}{Theorem}[section]
  \newtheorem{postulate}[theorem]{Postulate}
  \newtheorem{proposition}[theorem]{Proposition}
  \newtheorem*{proposition*}{Proposition}
  \newtheorem{lemma}[theorem]{Lemma}
\theoremstyle{definition}
  \newtheorem{definition}[theorem]{Defn}
  \newtheorem*{definition*}{Defn}

\theoremstyle{btProblem}
    \newtheorem{problem}{\@problemtitle}
    \newtheorem{subproblem}{}[problem]
\theoremstyle{btProblem*}
    \newtheorem{problem*}[problem]{\@problemtitle}

\renewcommand{\thesubproblem}{(\alph{subproblem})}

% solution
%   Solution to a problem. Like proof, but without the qedsymbol.
\newenvironment{solution}[1][\@btSolutionTitle]{%%
  \begin{proof}[#1]\leavevmode\newline%%
  \renewcommand{\qedsymbol}{}%%
}{%%
  \end{proof}%%
}

%
% Textmode macros
% TODO
%
% Default style for a "definition" term, i.e. for when you define a word.
\newcommand{\defn}[1]{{\bfseries#1}}
% Legacy support (may be deprecated).
\newcommand{\df}{\defn}


%
% Mathmode shorthand
%
% Short for nonumber, when you want one number for multiline equation block.
\newcommand{\nn}{\nonumber}

\newcommand{\dummycdot}{\,\cdot\,}

% Swap var symbols.
\let\oldepsilon\epsilon
\let\oldvarepsilon\varepsilon
\renewcommand{\epsilon}{\oldvarepsilon}
\renewcommand{\varepsilon}{\oldepsilon}
\let\oldphi\phi
\let\oldvarphi\varphi
\renewcommand{\phi}{\oldvarphi}
\renewcommand{\varphi}{\oldphi}

% Superior over-symbols.
\let\oldbar\bar \let\bar\relax \let\bar\overline
\let\oldtilde\tilde \let\tilde\relax \let\tilde\widetilde

% Slanted order symbols are way sexier.
\let\oldleq\leq \let\leq\relax \let\leq\leqslant
\let\oldgeq\geq \let\geq\relax \let\geq\geqslant

% Math operators.
% Convention: We use the natural case unless name conflict, in which case
% capitalize until no conflict.
\DeclareMathOperator{\Span}{span}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\ran}{ran}
\DeclareMathOperator{\Rank}{rank}
\DeclareMathOperator{\cof}{cof}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\image}{im}
\newcommand{\littleo}{{\scriptstyle\mathcal{O}}}
\newcommand{\bigo}{\mathcal{O}}
\DeclareMathOperator{\proj}{pr}
\DeclareMathOperator{\vol}{vol}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\Alt}{Alt}
\let\grad\relax \DeclareMathOperator{\grad}{grad}
\let\curl\relax \DeclareMathOperator{\curl}{curl}
\let\div\relax \DeclareMathOperator{\div}{div}
\DeclareMathOperator{\gcf}{gcf}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\Abs}{abs}
%\newcommand{\D}{\partial}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\nil}{nil}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\Max}{Max}
\DeclareMathOperator{\ob}{ob}
\newcommand{\category}[1]{\textsf{\textbf{#1}}}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Nat}{Nat}
\newcommand{\emf}{\ensuremath{\mathcal{E}}}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\rel}{\ rel\ }
\DeclareMathOperator{\supp}{supp}
\newcommand{\I}{\mathds{I}}
\newcommand{\II}{\mathds{II}}

% The identity map.
\newcommand{\1}{\mathds{1}}

% Recirpocate a \frac with fewer steps.
\newcommand{\recipr}[2]{\frac{#2}{#1}}

% In and around quantities.
\newcommand{\floor}[1]{\left\lfloor#1\right\rfloor}
\newcommand{\ceil}[1]{\left\lceil#1\right\rceil}
\newcommand{\midqty}[2]{\left.#1\ \middle\vert\ #2\right.}

% Quads.
\newcommand{\qqquad}{\quad\qquad}
\newcommand{\qcom}{\qq*{,}}
\newcommand{\qocand}{\qcom\qand*}
\newcommand{\qwhere}{\qq{where}}
\newcommand{\qwhen}{\qq{when}}
\newcommand{\qst}{\qq{s.t.}}

% Object symbols.
\newcommand{\sset}[1]{\mathbb{#1}}
\newcommand{\N}{\sset{N}}
\newcommand{\Z}{\sset{Z}}
\newcommand{\Q}{\sset{Q}}
\newcommand{\R}{\sset{R}}
\let\C\relax \newcommand{\C}{\sset{C}}
\newcommand{\F}{\sset{F}}
\newcommand{\powerset}{\mathcal{P}}


%
% Headers
%

% Title parameters.
\title{}
\date{\today}
\AL
\newcommand{\@namespace}{}
    \newcommand{\namespace}[1]{\renewcommand{\@namespace}{#1}}
\newcommand{\@titletype}{}
    \newcommand{\titletype}[1]{\renewcommand{\@titletype}{#1}}
\newcommand{\@subtitle}{}
    \newcommand{\subtitle}[1]{\renewcommand{\@subtitle}{#1}}
\newcommand{\@authorOther}{}
    \newcommand{\authorOther}[1]{\renewcommand{\@authorOther}{#1}}
\AO

% "Of" word to use in "page X of Y"
\newcommand{\btPageOfWord}{of}

% Geometry.
\setlength{\headheight}{15.2pt}
\renewcommand{\headrulewidth}{0.8pt}
\renewcommand{\footrulewidth}{0.8pt}
\setlength{\headsep}{0.1in}

% Format fancyhdr
\pagestyle{fancyplain}
\fancyhf{}
\AL
\fancyhead[L]{\@titletype}
\fancyhead[C]{\@title}
\fancyhead[R]{\@author}
\fancyfoot[L]{\@namespace}
\fancyfoot[C]{\@date}
\fancyfoot[R]{\thepage\ \btPageOfWord\ \pageref{LastPage}}
\AO

%
% Title page
%
% Page style for title page (no other content).
\fancypagestyle{btTitlePage}{
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
    \fancyhf{}
    \fancyfoot[C]{\@date}
}

% Page style for page that has title and maybe other content.
\fancypagestyle{btTitlePageWithContent}{
    \renewcommand{\headrulewidth}{0pt}
    \fancyhf{}
    \fancyfoot[C]{\@date}
    \fancyfoot[R]{\thepage\ \btPageOfWord\ \pageref{LastPage}}
}

% btMakeTitleText
%   Print the title text without external typesetting like headers, etc.
\newcommand{\btMakeTitleText}{%%
    \begin{doublespace}
        \begin{center}%%
            \LARGE%%
                \@title%%
            \large%%
                \btThisIfThat{\\\@subtitle}{\@subtitle}%%
                \\\@author%%
                \btThisIfThat{\\\@authorOther}{\@authorOther}%%
            \normalsize%%
                \\\@namespace%%
        \end{center}%%
    \end{doublespace}%%
}

% btMakeTitlePage
%   Create a new page, put the title on it, and fix headers for title page.
\newcommand{\btMakeTitlePage}{%%
    \thispagestyle{btTitlePage}
    \newpage{}%%
    \vspace*{3in}%%
    \btMakeTitleText{}%%
}

% btMakeTitle
%   Print the title on a page with possible other content, but change headers
%   accordingly.
\newcommand{\btMakeTitle}{%%
    \thispagestyle{btTitlePageWithContent}
    \btMakeTitleText{}%%
}
